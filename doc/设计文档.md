# 系统设计文档

## 1. 概述

本系统主要实现账户管理及交易处理。账户管理功能支持创建账户、获取账户信息等。交易功能支持处理交易、查询交易状态等。系统使用单体架构，部署在K8S环境中，数据库采用MySQL，缓存使用Redis，分布式锁由Redis提供支持。

## 2. 技术架构

### 2.1 架构图

```plaintext
+-------------------------------------------+
|            Kubernetes Cluster             |
|                                           |
|                  HPA                      |
|  +-------------+      +-----------+       | 
|  |             |      |           |       |  
|  |  Web App    |      |  Web App  |       |  
|  | (webflux)   |      | (webflux) |       |
|  |             |      |           |       |   
|  +-------------+      +-----------+       |  
|          | \          /     |             |
+----------+------------------+-------------+
           |    \    /        |           
           |      \ /         |           
           v      / \         v           
  +---------------+    +----------------+       
  |   MySQL 5.7   |    |   Redis 6.2    |       
  |               |    |                |       
  +---------------+    +----------------+       


```
###  2.2 技术栈
- 后端框架：Spring Boot 3.4, WebFlux
- 数据库：MySQL 5.7.x
- 缓存：Redis 6.2.x
- 容器化部署：Kubernetes (K8S) + HPA
- 分布式锁：Redis
##  3 核心业务逻辑
### 3.1 交易处理逻辑
#### 1.交易处理接口

- 幂等性保障：基于 bizId 进行幂等性校验，防止重复提交。
- 乐观锁机制：基于 version 字段实现乐观锁，确保并发操作的正确性。
#### 2.交易流程

- 获取分布式锁：以 bizId 为标识获取 Redis 分布式锁。
- 校验：
  - 确保 sourceAccount 和 targetAccount 不同。
  - 确认源账户余额是否足够。
  - 检查目标账户是否存在，且货币类型和源账户一致。
  - 校验交易请求的货币类型是否与源账户一致。
- 更新数据库：
    - 在校验通过后，开启事务，更新源账户和目标账户余额，更新交易记录状态为 PROCESSING。
  - 乐观锁机制：在更新账户时，需要进行重试机制（最多 3 次），每次重试间隔为 50ms * (n+1)。
  - 重试次数超过 3 次，则标记交易为 RETRY，如果成功，则标记为 SUCCESS。
- 释放分布式锁并返回交易状态。
#### 3.异步重试任务

每 1 分钟 + 随机 30 秒查询所有 RETRY 或状态为 PENDING, PROCESSING 且更新时间大于 5 分钟的交易记录，重新处理交易。

### 3.2 数据缓存
- 缓存策略：
    - 使用 Redis 缓存账户信息和交易记录，TTL 为 2 小时。
    - 当账户余额或交易记录状态更新时，删除对应的缓存。
### 3.3 异常处理
- 捕获 Redis 锁失败、数据库操作失败等异常，统一封装成 BizException，记录日志并返回具体错误信息。